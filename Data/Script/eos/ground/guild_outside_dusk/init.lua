--[[
    init.lua
    Created: 11/22/2023 13:09:48
    Description: Autogenerated script file for the map guild_outside_dusk.
]]--
-- Commonly included lua functions and data
require 'eos.common'
require 'eos.CharacterActions'
require 'eos.ExplorerEssentials'

-- Package name
local guild_outside_dusk = {}

-- Local, localized strings table
-- Use this to display the named strings you added in the strings files for the map!
-- Ex:
--      local localizedstring = STRINGS.MapStrings['SomeStringName']


-------------------------------
-- Map Callbacks
-------------------------------
---guild_outside_dusk.Init(map)
--Engine callback function
function guild_outside_dusk.Init(map)

  --This will fill the localized strings table automatically based on the locale the game is 
  -- currently in. You can use the MapStrings table after this line!
  
COMMON:RespawnAllies()
end

---guild_outside_dusk.Enter(map)
--Engine callback function
function guild_outside_dusk.Enter(map)
GROUND:Hide("TEAMMATE_2")

  if SV.Progression.Chapter == 1 then
	GAME:CutsceneMode(true)
  
        guild_outside_dusk.PartnerWimpsOut()
	
	GAME:WaitFrames(60)
	
	--next scene
	GAME:EnterGroundMap("dusk_beach", "C1S1_PlayerSpawn")
	
  end

  if SV.Progression.Chapter == 2 then
	GAME:CutsceneMode(true)
  
	if SV.Progression.Chapter == 2 and SV.Progression.SectionFlag == 1 then
	guild_outside_dusk.Chapter2Scene1()
	GAME:WaitFrames(60)
	--next scene
	--GAME:EnterGroundMap("guild_under_grate", "CH2_SentryView") TODO
	SV.Progression.SectionFlag = 2 -- remove this
	end

	if SV.Progression.Chapter == 2 and SV.Progression.SectionFlag == 2 then
	guild_outside_dusk.Chapter2Scene2()
	--GAME:EnterGroundMap("guild_topfloor", "Entrance") TODO
	SV.Progression.SectionFlag = 11 -- remove this
	GAME:EnterZone('hub', -1, 5, 0) -- remove this
	end
	
  end


end

---guild_outside_dusk.Exit(map)
--Engine callback function
function guild_outside_dusk.Exit(map)


end

---guild_outside_dusk.Update(map)
--Engine callback function
function guild_outside_dusk.Update(map)


end

---guild_outside_dusk.GameSave(map)
--Engine callback function
function guild_outside_dusk.GameSave(map)


end

---guild_outside_dusk.GameLoad(map)
--Engine callback function
function guild_outside_dusk.GameLoad(map)

  GAME:FadeIn(20)

end

-------------------------------
-- Entities Callbacks
-------------------------------



-------------------------------
-- Cutscene Functions
-------------------------------

function guild_outside_dusk.PartnerWimpsOut()
	local hTalkKind = SV.Personality.HeroTalkKind
	local pTalkKind = SV.Personality.PartnerTalkKind
	
	GROUND:SetPlayer(GAME:GetPlayerPartyMember(1))
	UI:SetSpeaker(GAME:GetPlayerPartyMember(1))
	local player = CH("PLAYER")
	local marker = MRKR("CH1_PartnerSpawn")
	local cam = MRKR("CamPos_1")
	GROUND:TeleportTo(player, marker.Position.X, marker.Position.Y, Direction.Up)
	GAME:MoveCamera(cam.Position.X, cam.Position.Y, 1, false)
  
    local coro1 = TASK:BranchCoroutine(function() SOUND:FadeInSE("Ambient/AMB_Fire_Loud", 60) end)
	local coro2 = TASK:BranchCoroutine(function() GAME:FadeIn(60) end)
	TASK:JoinCoroutines({coro1, coro2})
	
    GAME:WaitFrames(60)
    UI:SetSpeakerEmotion("Worried")
	UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH1_Partner_1']))
	
	GROUND:MoveInDirection(player, Direction.Right, 24, false, 1)
	GROUND:MoveInDirection(player, Direction.Left, 48, false, 1)
	GROUND:MoveInDirection(player, Direction.Right, 48, false, 1)
	GROUND:MoveInDirection(player, Direction.Left, 24, false, 1)
	
	GAME:WaitFrames(45)
	
	GROUND:CharAnimateTurnTo(player, Direction.Up, 2)
	
	UI:SetSpeakerEmotion("Determined")
	UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH1_Partner_2']))
	UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH1_Partner_3_'..tostring(pTalkKind)]))
	
	GROUND:MoveInDirection(player, Direction.Up, 24, false, 1)
	
	SOUND:PlayBattleSE("EVT_Emote_Shock")
	GROUND:CharSetEmote(player, "shock", 1)
	UI:ResetSpeaker()
	UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH1_Unknown_1']))
	
	CharacterActions.ScaredJump(player, Direction.Up)
	
	UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH1_Unknown_2']))
	UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH1_Unknown_3'], _DATA:GetMonster(GAME:GetPlayerPartyMember(1).CurrentForm.Species):GetColoredName()))
	
	GROUND:CharSetEmote(player, "shock", 1)
	GROUND:AnimateInDirection(player, "Walk", Direction.Up, Direction.Down, 12, 1, 2)
	UI:SetSpeaker(GAME:GetPlayerPartyMember(1))
	UI:SetSpeakerEmotion("Surprised")
	UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH1_Partner_4']))
	
	SOUND:PlayBattleSE("EVT_Emote_Confused_2")
    GROUND:CharSetEmote(player, "sweating", 1)
    GROUND:CharAnimateTurnTo(player, Direction.Right, 1)
    GAME:WaitFrames(5)
    GROUND:CharAnimateTurnTo(player, Direction.Left, 1)
    GAME:WaitFrames(15)
    GROUND:CharAnimateTurnTo(player, Direction.Right, 1)
    GAME:WaitFrames(5)
    GROUND:CharAnimateTurnTo(player, Direction.Up, 1)
    GAME:WaitFrames(45)
    GROUND:CharSetEmote(player, "sweating", 1)
	
	UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH1_Partner_5_'..tostring(pTalkKind)]))
	
	GAME:WaitFrames(30)
	SOUND:PlayBattleSE("EVT_Emote_Sweatdrop")
	GROUND:CharSetEmote(player, "sweatdrop", 1)
	UI:SetSpeakerEmotion("Sigh")
	UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH1_Partner_6']))
	
	GAME:WaitFrames(15)
	UI:SetSpeakerEmotion("Sad")
	UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH1_Partner_7_'..tostring(pTalkKind)]))
	UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH1_Partner_8_'..tostring(pTalkKind)]))
	
	GROUND:MoveInDirection(player, Direction.Up, 16, false, 1)
	SOUND:PlayBattleSE("EVT_CH02_Item_Place")
	GROUND:TeleportTo(OBJ("RelicFragment"), player.Position.X, player.Position.Y - 1, Direction.Down)
	GAME:WaitFrames(15)
	GROUND:AnimateInDirection(player, "Walk", Direction.Up, Direction.Down, 16, 1, 1)
	GAME:WaitFrames(30)
	
	UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH1_Partner_9']))
	
	GAME:WaitFrames(30)
	GROUND:MoveInDirection(player, Direction.Up, 16, false, 1)
	GROUND:Hide("RelicFragment")
	GAME:WaitFrames(15)
	GROUND:AnimateInDirection(player, "Walk", Direction.Up, Direction.Down, 16, 1, 1)
	
	GAME:WaitFrames(45)
	CharacterActions.ShakeHead(player, Direction.Up)
	GAME:WaitFrames(30)
	
	UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH1_Partner_10_'..tostring(pTalkKind)]))
	UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH1_Partner_11']))
	UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH1_Partner_12']))
	
	GROUND:CharAnimateTurnTo(player, Direction.Down, 5)
	GAME:WaitFrames(20)
	
	local coro1 = TASK:BranchCoroutine(function() GROUND:MoveInDirection(player, Direction.Down, 240, false, 1) end)
	local coro2 = TASK:BranchCoroutine(function() GAME:MoveCamera(cam.Position.X, (cam.Position.Y + 125), 120, false) end)
	TASK:JoinCoroutines({coro1, coro2})
	
	GAME:WaitFrames(90)
	
	local koffing = CH("Koffing")
	local zubat = CH("Zubat")
	marker = MRKR("CH1_KoffingSpawn")
	GROUND:TeleportTo(koffing, marker.Position.X, (marker.Position.Y - 20), Direction.Down)
	marker = MRKR("CH1_ZubatSpawn")
	GROUND:TeleportTo(zubat, marker.Position.X, (marker.Position.Y - 20), Direction.Down)
	
	local pos1 = MRKR("CH1_KoffingPos")
	local pos2 = MRKR("CH1_ZubatPos")
	
	local coro1 = TASK:BranchCoroutine(function() GAME:WaitFrames(10)
										GROUND:MoveToPosition(koffing, pos1.Position.X, pos1.Position.Y, false, 1)
										GROUND:CharAnimateTurnTo(koffing, Direction.Down, 5)	end)
	local coro2 = TASK:BranchCoroutine(function() GROUND:MoveToPosition(zubat, pos2.Position.X, pos2.Position.Y, false, 1)
										GROUND:CharAnimateTurnTo(zubat, Direction.Down, 5)	end)
	local coro3 = TASK:BranchCoroutine(function() GAME:MoveCamera(cam.Position.X, cam.Position.Y, 180, false) end)
	TASK:JoinCoroutines({coro1, coro2, coro3})
	
	GAME:WaitFrames(45)
	
	--"\uE040"
	UI:SetSpeaker('', true, koffing.CurrentForm.Species, koffing.CurrentForm.Form, koffing.CurrentForm.Skin, koffing.CurrentForm.Gender)
	UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH1_Koffing_1'], zubat:GetDisplayName()))
	
	GAME:WaitFrames(10)
	UI:SetSpeaker(zubat)
	UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH1_Zubat_1'], koffing:GetDisplayName()))
	
	GAME:WaitFrames(10)
	UI:SetSpeaker(koffing)
	UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH1_Koffing_2']))
	
	GAME:WaitFrames(10)
	UI:SetSpeaker(zubat)
	UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH1_Zubat_2']))
	
	GAME:WaitFrames(10)
	GROUND:CharTurnToCharAnimated(koffing, zubat, 4, true)
	UI:SetSpeaker(koffing)
	UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH1_Koffing_3']))
	
	GAME:WaitFrames(10)
	GROUND:CharTurnToCharAnimated(zubat, koffing, 4, true)
	UI:SetSpeaker(zubat)
	UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH1_Zubat_3']))
	
	--nod
	local coro1 = TASK:BranchCoroutine(function() GROUND:CharSetAnim(koffing, "Nod", false)
										GAME:WaitFrames(45)
										GROUND:MoveInDirection(koffing, Direction.Down, 180, false, 1)	end)
	local coro2 = TASK:BranchCoroutine(function() GROUND:CharSetAnim(zubat, "Nod", false)
										GAME:WaitFrames(45)
										GAME:WaitFrames(10)
										GROUND:MoveInDirection(zubat, Direction.Down, 180, false, 1)	end)
	local coro3 = TASK:BranchCoroutine(function() GAME:WaitFrames(300)
										GAME:FadeOut(false, 60) end)
	local coro4 = TASK:BranchCoroutine(function() GAME:WaitFrames(300)
										SOUND:FadeOutSE("Ambient/AMB_Fire_Loud", 150)
										end)
	TASK:JoinCoroutines({coro1, coro2, coro3, coro4})
end

function guild_outside_dusk.Chapter2Scene1()

	local player = CH("PLAYER")
	local partner = CH("TEAMMATE_1") --why does this have to be like this?
	
	local hTalkKind = SV.Personality.HeroTalkKind
	local pTalkKind = SV.Personality.PartnerTalkKind
	
	local cam = MRKR("CamPos_1")
        GAME:MoveCamera(cam.Position.X, cam.Position.Y, 1, false)
	local marker = MRKR("CH1_ZubatPos")
        GROUND:TeleportTo(player, marker.Position.X, marker.Position.Y, Direction.Up)
	local marker = MRKR("CH1_KoffingPos")
        GROUND:TeleportTo(partner, marker.Position.X, marker.Position.Y, Direction.Up)

	
	--UI:SetSpeaker(partner)
	--UI:SetSpeakerEmotion("Normal")
        --UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Partner_1']))
	GROUND:CharAnimateTurnTo(player, Direction.Left, 2)	
	GROUND:CharAnimateTurnTo(partner, Direction.Right, 2)
        --UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Partner_2']))
        --UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Partner_3']))
	GROUND:CharAnimateTurnTo(player, Direction.Up, 2)	
	GROUND:CharAnimateTurnTo(partner, Direction.Up, 2)
	--UI:SetSpeakerEmotion("Worried")
        --UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Partner_4']))
	GROUND:CharAnimateTurnTo(player, Direction.Left, 2)	
	GROUND:CharAnimateTurnTo(partner, Direction.Right, 2)
        --UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Partner_5']))
	GROUND:CharAnimateTurnTo(player, Direction.Up, 2)	
	GROUND:CharAnimateTurnTo(partner, Direction.Up, 2)
	--UI:SetSpeakerEmotion("Determined")
        --UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Partner_5']))
	CharacterActions.ScaredJump(partner, Direction.Up)
        --UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Partner_6']))
	GROUND:MoveToPosition(partner, marker.Position.X + 16, marker.Position.Y - 12, false, 1)
	GROUND:MoveToPosition(partner, marker.Position.X + 16, marker.Position.Y - 24, false, 1)

	UI:ResetSpeaker()
	GROUND:CharSetEmote(partner, "shock", 1)
	UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH1_Unknown_1']))		
	UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH1_Unknown_2']))
	UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH1_Unknown_3'], _DATA:GetMonster(GAME:GetPlayerPartyMember(1).CurrentForm.Species):GetColoredName()))
	--UI:SetSpeaker(partner)
	--UI:SetSpeakerEmotion("Worried")
        --UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Partner_7']))
	--UI:SetSpeakerEmotion("Normal")
        --UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Partner_8']))
	--UI:ResetSpeaker()
	--UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Unknown_1'])) --you may enter dialoge
	--UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Unknown_2']))
	GROUND:MoveToPosition(partner, marker.Position.X - 24, marker.Position.Y - 24, false, 1)
        GROUND:CharAnimateTurnTo(partner, Direction.Right, 2)
        GROUND:CharAnimateTurnTo(partner, Direction.DownRight, 2)
	GROUND:CharSetEmote(partner, "sweating", 1)
	--UI:SetSpeaker(partner)
	--UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Partner_9']))
        GROUND:CharAnimateTurnTo(partner, Direction.Right, 2)
	--UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Partner_10']))
        GROUND:CharAnimateTurnTo(partner, Direction.DownRight, 2)
	--UI:SetSpeaker(player)
	--UI:SetSpeakerEmotion("Normal")
	--UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Player_1']))
	--UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Player_2']))
	--UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Player_3']))
	--UI:SetSpeakerEmotion("Worried")
	--UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Player_4']))
	--UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Player_5']))
	--UI:ResetSpeaker()
	--UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Unknown_3']))
	GROUND:MoveToPosition(player, marker.Position.X + 16, marker.Position.Y - 12, false, 1)
        GROUND:MoveToPosition(player, marker.Position.X + 16, marker.Position.Y - 24, false, 1)
        GROUND:CharAnimateTurnTo(partner, Direction.Right, 2)
	
	--UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH1_Unknown_1']))
        CharacterActions.ScaredJump(player, Direction.Up)

        --UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH1_Unknown_2']))
	--UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Unknown_4']))
	--UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Unknown_5']))
	--UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Unknown_6']))
	--UI:ResetSpeaker()
	--UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Diglett_1']))
	--insert transition to underground of the grate here
	--for now
	--SV.Chapter2.SentryGrate = 1
end

function guild_outside_dusk.Chapter2Scene2()

	local player = CH("PLAYER")
	local partner = CH("TEAMMATE_1") --why does this have to be like this?
	
	local hTalkKind = SV.Personality.HeroTalkKind
	local pTalkKind = SV.Personality.PartnerTalkKind
	
	local cam = MRKR("CamPos_1")
        GAME:MoveCamera(cam.Position.X, cam.Position.Y, 1, false)
	local marker = MRKR("CH1_ZubatPos")
        GROUND:TeleportTo(player, marker.Position.X - 16, marker.Position.Y - 24, Direction.Up)
	local marker = MRKR("CH1_KoffingPos")
        GROUND:TeleportTo(partner, marker.Position.X - 24, marker.Position.Y - 24, Direction.Right)
	GROUND:CharSetEmote(player, "sweatdrop", 1)
	GROUND:CharSetEmote(partner, "sweatdrop", 1)
	GROUND:CharAnimateTurnTo(player, Direction.Left, 2)
	--UI:SetSpeaker(partner)
	--UI:SetSpeakerEmotion("Worried")
	--UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Partner_11']))
	--UI:ResetSpeaker()
        --UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Unknown_7']))
	GROUND:CharSetEmote(player, "notice", 1)
	GROUND:CharSetEmote(player, "notice", 1)
	GROUND:CharAnimateTurnTo(player, Direction.Up, 2)
	--UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Unknown_8']))
	--UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Unknown_9']))
	--UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Unknown_10']))
	--gate opens here somehow
	GROUND:CharAnimateTurnTo(partner, Direction.UpRight, 2)
	CharacterActions.ScaredJump(partner, Direction.Up)
	GROUND:CharSetEmote(player, "shock", 1)
	GROUND:CharAnimateTurnTo(partner, Direction.Right, 2)
	GROUND:CharAnimateTurnTo(player, Direction.Left, 2)
	--UI:SetSpeaker(partner)
	--UI:SetSpeakerEmotion("Shock")
	--UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Partner_12']))
	--UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Partner_13']))
	--UI:SetSpeakerEmotion("Normal")
	--UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Partner_14']))
	--UI:WaitShowDialogue(STRINGS:Format(STRINGS.MapStrings['CH2_Partner_15']))
	GROUND:MoveToPosition(player, marker.Position.X + 16, marker.Position.Y - 40, false, 1)	
	GROUND:Hide("PLAYER")
	GROUND:MoveToPosition(partner, marker.Position.X + 16, marker.Position.Y - 24, false, 1)	
	GROUND:MoveToPosition(partner, marker.Position.X + 16, marker.Position.Y - 40, false, 1)	
	GROUND:Hide("TEAMMATE_1")
	--GAME:FadeOut(false, 60)
	--jump to scene inside top of guild

end



return guild_outside_dusk

